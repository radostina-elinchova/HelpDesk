@model HelpDeskApp.ViewModels.Models.Project.ProjectDetailsVM

@{
    ViewData["Title"] = "Project Details";
}

<div class="odoo-container">
    <div class="odoo-card">
        <div class="odoo-card-header odoo-header-actions">
            <div>
                <h3>@Model.ProjectName</h3>
                <p class="odoo-subtitle">Project details</p>
            </div>

            @* @if (User.Identity!.IsAuthenticated && User.IsInRole("Administrator"))
            { *@
                <a asp-action="Edit"
                   asp-route-id="@Model.Id"
                   class="btn odoo-btn-primary">
                    Edit
                </a>
            @* } *@
        </div>
        <div class="odoo-card-body">
            <div class="odoo-form odoo-form-readonly">

                <div class="odoo-field">
                    <label class="odoo-label">Project Name</label>
                    <div class="odoo-value">
                        @Model.ProjectName
                    </div>
                </div>

                <div class="odoo-field">
                    <label class="odoo-label">Description</label>
                    <div class="odoo-value odoo-value-multiline">
                        @Model.Description
                    </div>
                </div>

            </div>
        </div>

        <div class="odoo-card-body border-top">

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">
                    Team Members
                    <span class="badge odoo-badge ms-2">
                        @Model.AssignedUsers.Count
                    </span>
                </h5>
            </div>

            @if (Model.AssignedUsers.Any())
            {
                <div class="table-responsive">
                    <table class="table odoo-table align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="text-end" style="width:100px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.AssignedUsers)
                            {
                                <tr>
                                    <td>@user.FullName</td>
                                    <td class="text-end">

                                        @* @if (User.IsInRole("Administrator"))
                                        { *@
                                            <form asp-action="RemoveUser" method="post">
                                                <input type="hidden" name="projectId" value="@Model.Id" />
                                                <input type="hidden" name="userId" value="@user.Id" />
                                                <button type="submit"
                                                        class="btn btn-sm btn-outline-danger">
                                                    ✖
                                                </button>
                                            </form>
                                        @* } *@

                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="odoo-empty-state text-center py-3 text-muted">
                    No team members assigned
                </div>
            }

            @if (Model.AvailableUsers != null && Model.AvailableUsers.Any())
            {
                <form asp-action="AddUser"
                      method="post"
                      class="d-flex gap-2 mt-3">

                    <input type="hidden" name="projectId" value="@Model.Id" />

                    <select name="userId"
                            class="odoo-input"
                            style="max-width:300px;">
                        <option value="">-- Select user --</option>
                        @foreach (var user in Model.AvailableUsers)
                        {
                            <option value="@user.Id">@user.FullName</option>
                        }
                    </select>

                    <button type="submit" class="btn odoo-btn-primary">Add User</button>
                </form>
            }
            else
            {               
                <div class="alert alert-info mt-3 py-2 small">
                    Всички налични потребители вече са добавени към този проект.
                </div>
            }

        </div>
        <div class="odoo-card-body border-top">

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Tickets</h5>

                <a asp-controller="Ticket"
                   asp-action="Create"
                   asp-route-projectId="@Model.Id"
                   class="btn btn-sm odoo-btn-primary">
                    + New Ticket
                </a>
            </div>

            @if (Model.Tickets != null && Model.Tickets.Any())
            {
                <div class="table-responsive">
                    <table class="table odoo-table align-middle">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th class="text-end"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in Model.Tickets)
                            {
                                <tr>
                                    <td>@ticket.Title</td>
                                    <td>@ticket.Category</td>
                                    <td>
                                        <span class="badge odoo-badge">
                                            @ticket.Status
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <a asp-controller="Ticket"
                                           asp-action="Details"
                                           asp-route-id="@ticket.Id"
                                           class="btn btn-sm odoo-btn-secondary">
                                            Open
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="odoo-empty-state text-center py-4 text-muted">
                    Няма тикети към този проект
                </div>
            }

        </div>

        <div class="odoo-card-footer">
            <a asp-action="Index"
               class="btn odoo-btn-secondary">
                Back to list
            </a>
        </div>

    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
